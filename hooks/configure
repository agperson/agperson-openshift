#!/bin/bash
prog="configure"

set -e
PATH=/bin:/usr/bin:/sbin:/usr/sbin

nepho_dir=${NEPHO_NephoDir-"/opt/nepho"}
puppet_dir="${nepho_dir}/resources/common/puppet"
today="$(date '+%Y-%m-%d')"

# Pretty print informational and error messages
function message() {
  case $1 in
    fail ) echo -e "\n\033[0m${prog}: \033[1;31m${2}\033[0m" ;;
    info ) echo -e "\n\033[0m${prog}: \033[1;34m${2}\033[0m" ;;
  esac
}

function run_r10k() {
  # Use r10k to install Puppet modules
  if [[ -s ${puppet_dir}/Puppetfile ]]; then
    message info "Running r10k to download Puppet modules"
    pushd "${puppet_dir}" >/dev/null
    HOME=/root PUPPETFILE_DIR=/etc/puppet/modules r10k -v info puppetfile install
    popd >/dev/null
  else
    message info "No Puppetfile found, skipping r10k"
  fi
}

function run_puppet() {
  pushd "$puppet_dir" >/dev/null
  if [[ -f manifests/init.pp && -r manifests/init.pp ]]; then
    puppet apply \
      --modulepath /etc/puppet/modules:modules \
      --manifestdir manifests \
      --templatedir templates \
      --logdest console --logdest ${nepho_dir}/data/logs/puppet.${today}.log \
      manifests/init.pp
    message info "Finished $i Puppet run"
  fi
  popd >/dev/null
}

# Make sure we are in the directory of this script
cd $(dirname "${0}")

run_r10k
message info "Beginning first Puppet run"
run_puppet
message info "Beginning second Puppet run"
run_puppet

# vim: set ft=sh ts=2 sw=2 ei:
